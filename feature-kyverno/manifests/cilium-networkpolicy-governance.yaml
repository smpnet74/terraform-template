apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cilium-networkpolicy-governance
  annotations:
    policies.kyverno.io/title: Cilium Network Policy Governance
    policies.kyverno.io/category: Cilium
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: CiliumNetworkPolicy
    policies.kyverno.io/description: >-
      Ensures CiliumNetworkPolicy resources include required annotations
      and follow security best practices.
spec:
  validationFailureAction: Audit
  background: true
  rules:
  - name: require-policy-annotations
    match:
      any:
      - resources:
          kinds:
          - CiliumNetworkPolicy
    validate:
      message: "CiliumNetworkPolicy must include owner and purpose annotations"
      pattern:
        metadata:
          annotations:
            "policy.cilium.io/owner": "?*"
            "policy.cilium.io/purpose": "?*"
  - name: require-specific-rules
    match:
      any:
      - resources:
          kinds:
          - CiliumNetworkPolicy
    validate:
      message: "CiliumNetworkPolicy must specify explicit ingress or egress rules (empty rules create allow-all policies)"
      anyPattern:
      - spec:
          ingress:
          - "?*"  # At least one ingress rule must be specified
      - spec:
          egress:
          - "?*"  # At least one egress rule must be specified
      - spec:
          ingressDeny:
          - "?*"  # Or explicit deny rules
      - spec:
          egressDeny:
          - "?*"  # Or explicit deny rules